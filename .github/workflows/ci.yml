name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Skill
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check SKILL.md exists
        run: |
          if [ ! -f "SKILL.md" ]; then
            echo "❌ ERROR: SKILL.md not found!"
            exit 1
          fi
          echo "✅ SKILL.md exists"

      - name: Check SKILL.md frontmatter
        run: |
          if ! head -1 SKILL.md | grep -q "^---$"; then
            echo "❌ ERROR: SKILL.md missing frontmatter"
            exit 1
          fi
          echo "✅ SKILL.md has valid frontmatter"

      - name: Check SKILL.md version
        run: |
          if ! grep -q "^version:" SKILL.md; then
            echo "❌ ERROR: SKILL.md missing version field"
            exit 1
          fi
          VERSION=$(grep "^version:" SKILL.md | head -1 | cut -d: -f2 | tr -d ' ')
          echo "✅ SKILL.md version: $VERSION"

      - name: Check README.md exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "❌ ERROR: README.md not found!"
            exit 1
          fi
          echo "✅ README.md exists"

      - name: Check CHANGELOG.md exists
        run: |
          if [ ! -f "CHANGELOG.md" ]; then
            echo "❌ ERROR: CHANGELOG.md not found!"
            exit 1
          fi
          echo "✅ CHANGELOG.md exists"

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": false,
            "MD036": false
          }
          EOF

      - name: Run markdownlint
        run: |
          markdownlint '**/*.md' --ignore node_modules || true
          echo "⚠️ Markdown lint completed (warnings only, not blocking)"

  link-check:
    name: Check Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/workflows/mlc_config.json'
        continue-on-error: true
