# 目標分析 (Phase 1)

> 執行任務前的目標解析與明確性檢查
>
> 💡 **核心洞察**：寫 spec 最大的問題是「你不知道自己漏了什麼」
> — 來源：[@BensonTWN](https://x.com/BensonTWN/status/2010319050099110270)

## 目標明確性檢查（優先執行）

```
┌─────────────────────────────────────────────────────────┐
│  檢查項目：                                             │
│  □ 有具體的成功標準嗎？                                │
│  □ 有可量化的驗收條件嗎？                              │
│  □ 範圍是否明確？                                      │
│  □ 有技術/資源約束嗎？                                 │
│  □ 有時間/品質偏好嗎？                                 │
│  □ 需要架構設計嗎？（見下方判斷標準）                  │
└─────────────────────────────────────────────────────────┘

若有 ≥2 項不明確 → 使用 AskUserQuestion 確認
若只有 1 項不明確 → 用【假設】補齊，列出假設內容
若全部明確 → 進入深度訪談或直接目標解析（依任務複雜度）
```

## 架構考量觸發判斷

根據任務性質，判斷是否需要在 PDCA Plan 階段進行架構設計：

```
┌─────────────────────────────────────────────────────────────────┐
│  架構設計需求等級                                               │
│                                                                 │
│  Level 0: 不需要架構設計                                        │
│  ├─ Bug fix（修復現有功能）                                     │
│  ├─ 小幅修改（調整參數、文案、樣式）                           │
│  ├─ 單一函數/方法的變更                                        │
│  └─ 文檔更新                                                   │
│                                                                 │
│  Level 1: 輕量架構思考（PDCA Plan 時快速考慮）                  │
│  ├─ 新增單一功能（在現有模組內）                               │
│  ├─ 重構現有程式碼（不改變介面）                               │
│  └─ 效能優化                                                   │
│                                                                 │
│  Level 2: 完整架構設計（PDCA Plan 時深度考慮）                  │
│  ├─ 新增模組/服務                                              │
│  ├─ 跨多個模組的功能                                          │
│  ├─ 新增外部整合（API、資料庫、第三方服務）                   │
│  ├─ 變更核心架構/資料模型                                     │
│  └─ 建立新專案                                                │
└─────────────────────────────────────────────────────────────────┘
```

### 快速判斷表

| 任務特徵 | 架構等級 | Plan 階段行為 |
|----------|----------|---------------|
| 改個 bug、調參數 | Level 0 | 直接執行 |
| 新增一個 API endpoint | Level 1 | 快速考慮錯誤處理、命名 |
| 新增一個完整功能模組 | Level 2 | 完整架構設計流程 |
| 重構認證系統 | Level 2 | 完整架構設計流程 |
| 整合新的第三方服務 | Level 2 | 完整架構設計流程 |

### 標記方式

在目標分析完成後，標記架構等級：

```yaml
goal_analysis:
  goal: "建立用戶通知系統"
  architecture_level: 2  # 0, 1, or 2
  architecture_reason: "新增完整模組，涉及多種通知管道"
```

此標記會影響 PDCA Plan 階段的深度。

## 深度訪談模式（Deep Interview）

> 🎯 **目的**：主動發現用戶沒想到的問題，挖掘隱藏假設

### 觸發條件

| 條件 | 是否觸發 |
|------|----------|
| 架構等級 Level 2 | ✅ 強制觸發 |
| 架構等級 Level 1 + 用戶目標模糊 | ✅ 建議觸發 |
| 架構等級 Level 0 | ❌ 跳過 |
| 用戶明確說「快速完成」 | ❌ 跳過 |
| 涉及 spec-workflow 的 requirements 階段 | ✅ 強制觸發 |

### 訪談執行流程

```
┌─────────────────────────────────────────────────────────────────┐
│  深度訪談模式                                                   │
│                                                                 │
│  角色：資深技術顧問                                             │
│  工具：AskUserQuestion（多輪對話）                              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  每個問題前的 Ultrathink 分析（內部思考）               │   │
│  │                                                         │   │
│  │  1. 這個規格可能隱藏的假設是什麼？                     │   │
│  │  2. 哪些邊界情況沒有被考慮到？                         │   │
│  │  3. 技術債務可能在哪裡累積？                           │   │
│  │  4. 這個設計決策的二階、三階效應是什麼？               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            ↓                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  提出深入問題（使用 AskUserQuestion）                   │   │
│  │                                                         │   │
│  │  涵蓋面向：                                             │   │
│  │  • 技術實作細節                                         │   │
│  │  • UI/UX 考量                                           │   │
│  │  • 潛在疑慮與風險                                       │   │
│  │  • 設計取捨                                             │   │
│  │  • 邊界情況處理                                         │   │
│  │  • 錯誤處理策略                                         │   │
│  │  • 擴展性需求                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            ↓                                    │
│           持續訪談直到所有關鍵面向都被釐清                      │
│                            ↓                                    │
│                    產出完整的目標規格                           │
└─────────────────────────────────────────────────────────────────┘
```

### 訪談問題範本

使用 AskUserQuestion 時，問題應**深入且不流於表面**：

```
┌─────────────────────────────────────────────────────────────────┐
│  深度訪談問題範本                                               │
│                                                                 │
│  【隱藏假設探索】                                               │
│  • 當 X 發生時，系統應該如何反應？                              │
│  • 如果用戶在 Y 步驟中途離開，資料如何處理？                    │
│  • 這個功能是否假設用戶已經完成 Z？                             │
│                                                                 │
│  【邊界情況】                                                   │
│  • 當資料量超過 N 時，效能要求是什麼？                          │
│  • 並發操作時如何處理衝突？                                     │
│  • 網路中斷時的降級策略是什麼？                                 │
│                                                                 │
│  【技術債務預防】                                               │
│  • 這個設計未來可能需要如何擴展？                               │
│  • 哪些部分可能需要重構？                                       │
│  • 有沒有可以提前抽象化的元件？                                 │
│                                                                 │
│  【二階/三階效應】                                              │
│  • 這個功能對其他模組有什麼影響？                               │
│  • 對團隊工作流程有什麼改變？                                   │
│  • 對用戶行為可能產生什麼非預期的影響？                         │
└─────────────────────────────────────────────────────────────────┘
```

### 訪談結束條件

```
訪談結束於：
✅ 所有關鍵面向都已釐清（技術、UX、風險、取捨）
✅ 用戶表示「沒有其他要補充的」
✅ 連續 2 個問題用戶回答「這個不需要考慮」

訪談提前結束於：
⏸️ 用戶說「先這樣，之後再補充」
⏸️ 達到 10 個問題上限（避免疲勞）
```

### 訪談產出

訪談結束後，整理為結構化的目標規格：

```yaml
goal_specification:
  original_goal: "[用戶原始輸入]"
  clarified_goal: "[經過訪談後的精確描述]"

  success_criteria:
    - "[明確的成功標準 1]"
    - "[明確的成功標準 2]"

  scope:
    included:
      - "[包含的範圍]"
    excluded:
      - "[明確排除的範圍]"

  assumptions:
    - "[訪談中確認的假設]"

  edge_cases:
    - case: "[邊界情況]"
      handling: "[處理方式]"

  risks:
    - risk: "[潛在風險]"
      mitigation: "[緩解措施]"

  interview_insights:
    - "[訪談中發現的重要洞察]"
```

## 目標解析步驟

1. **解析目標**
   - 最終成功標準是什麼？
   - 如何驗證目標達成？
   - 有哪些約束條件？

2. **分解子目標**
   - 將大目標拆成可執行的步驟
   - 識別依賴關係
   - 設定每個步驟的驗收標準

3. **評估現有能力**
   - 需要哪些技能/工具？
   - 哪些已具備？哪些需要學習？

## 目標確認問卷（使用 AskUserQuestion）

當目標不明確時，**一次收齊**關鍵資訊：

```
┌─────────────────────────────────────────────────────────────────┐
│  ❓ 需要確認目標細節                                           │
│                                                                 │
│  您的目標：[用戶輸入的原始目標]                                 │
│                                                                 │
│  請幫我確認以下幾點：                                           │
│                                                                 │
│  1. 成功標準                                                    │
│     □ 能正常運作即可                                           │
│     □ 需要特定效能指標（請說明）                               │
│     □ 需要通過測試/驗收條件（請說明）                          │
│                                                                 │
│  2. 範圍限制                                                    │
│     □ 只處理核心功能                                           │
│     □ 需要完整實作（含邊界情況）                               │
│     □ 需要考慮擴展性                                           │
│                                                                 │
│  3. 品質 vs 速度                                                │
│     □ 快速完成優先（可接受後續優化）                           │
│     □ 品質優先（寧可慢也要做好）                               │
│     □ 平衡                                                     │
│                                                                 │
│  4. 其他約束                                                    │
│     □ 無特別限制                                               │
│     □ 有（請說明：技術棧/相容性/資源限制）                     │
└─────────────────────────────────────────────────────────────────┘
```

## 不明確目標範例

| 用戶輸入 | 缺少的資訊 | 需要確認 |
|----------|------------|----------|
| 「優化效能」 | 優化什麼？目標數值？ | ✅ |
| 「做一個網站」 | 什麼功能？什麼風格？ | ✅ |
| 「修好這個 bug」 | bug 現象？預期行為？ | ✅ |
| 「把這段程式碼重構成 TypeScript，要有型別定義」 | 全部明確 | ❌ |
| 「建立登入功能，要有 JWT 和刷新 token」 | 全部明確 | ❌ |
