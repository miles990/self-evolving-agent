# Self-Evolving Agent 實作指南

> 從觸發到完成的完整操作流程

---

## 快速開始

### 觸發指令

```
/evolve [目標描述]
```

### 範例

```bash
# 簡單目標
/evolve 優化這個 React component 的效能

# 複雜目標
/evolve 建立一個能自動生成遊戲道具圖片的 ComfyUI 工作流程，
       要求：透明背景、風格一致、可批量生成

# 學習型目標
/evolve 研究並實作 WebSocket 即時通訊功能
```

---

## 執行流程圖解

```
┌─────────────────────────────────────────────────────────────────┐
│                    /evolve 被觸發                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 0: 目標明確性檢查                                        │
│  ├── 有具體成功標準？                                           │
│  ├── 有可量化驗收條件？                                         │
│  ├── 範圍明確？                                                 │
│  └── ≥2 項不明確 → 詢問用戶確認                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
             [目標明確]           [需要確認]
                    │                   │
                    │         ┌─────────▼─────────┐
                    │         │  AskUserQuestion  │
                    │         │  一次收齊關鍵資訊  │
                    │         └─────────┬─────────┘
                    │                   │
                    └─────────┬─────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: 目標分析                                              │
│  ├── 解析最終成功標準                                           │
│  ├── 分解成可驗證的子目標                                       │
│  └── 評估需要哪些技能/工具                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: PDCA 循環（每個子目標）                               │
│                                                                 │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐     │
│  │  Plan   │ ─→ │   Do    │ ─→ │  Check  │ ─→ │   Act   │     │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘     │
│       ↑                                            │            │
│       └────────────── 失敗時重試 ←─────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 3: 反思與學習（失敗時觸發）                              │
│  ├── 分析錯誤原因                                               │
│  ├── WebSearch 搜尋解決方案                                     │
│  ├── 更新執行策略                                               │
│  └── 將學習寫入 Memory                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  完成條件檢查                                                   │
│  ├── ✅ 所有子目標完成 → 結束                                  │
│  ├── ❌ 達到最大迭代（10次）→ 暫停並報告                       │
│  └── ⚠️ 需要用戶決策 → 等待輸入                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 進度報告格式

執行過程中會顯示即時進度：

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 進度更新                                                   │
│                                                                 │
│  目標：建立 ComfyUI 工作流程                                    │
│  進度：███████░░░ 70%                                          │
│  迭代：第 3 次（最大 10 次）                                    │
│                                                                 │
│  ✅ 已完成：                                                   │
│     1. 安裝 ComfyUI ✓                                          │
│     2. 下載基礎模型 ✓                                          │
│     3. 建立基本工作流程 ✓                                      │
│                                                                 │
│  🔄 進行中：                                                   │
│     4. 加入 LoRA 支援                                          │
│        └─ 嘗試 #2：使用 LoraLoader 節點                        │
│                                                                 │
│  ⏳ 待完成：                                                   │
│     5. 批量生成功能                                             │
│     6. 輸出格式優化                                             │
│                                                                 │
│  📝 本次學習：                                                  │
│     - LoRA 需要 LoraLoader 節點（不是 Load LoRA）              │
│     - 需要設定 strength_model 參數                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 用戶互動時機

### 0. 目標不明確時（優先觸發）

當目標缺少關鍵資訊時，Agent 會先確認：

```
┌─────────────────────────────────────────────────────────────────┐
│  ❓ 需要確認目標細節                                           │
│                                                                 │
│  您的目標：「優化效能」                                         │
│                                                                 │
│  我需要確認幾個問題才能開始：                                   │
│                                                                 │
│  1. 成功標準                                                    │
│     A. 能正常運作即可                                           │
│     B. 需要特定效能指標（如：載入時間 < 2秒）                   │
│     C. 需要通過測試/驗收條件                                    │
│                                                                 │
│  2. 範圍限制                                                    │
│     A. 只處理核心功能                                           │
│     B. 需要完整實作（含邊界情況）                               │
│     C. 需要考慮未來擴展性                                       │
│                                                                 │
│  3. 品質 vs 速度                                                │
│     A. 快速完成優先                                             │
│     B. 品質優先                                                 │
│     C. 平衡                                                     │
└─────────────────────────────────────────────────────────────────┘
```

**觸發條件**：以下 ≥2 項不明確
- 成功標準
- 可量化驗收條件
- 範圍邊界
- 技術/資源約束
- 品質/速度偏好

**不會觸發的情況**：
```bash
# 這些目標已經夠明確，不會額外確認
/evolve 把 UserList.jsx 重構成 TypeScript，加上完整型別定義
/evolve 優化首頁載入時間到 2 秒以內
/evolve 修復 #123 issue 描述的登入失敗問題
```

### 1. 需要決策時

```
┌─────────────────────────────────────────────────────────────────┐
│  ❓ 需要您的決定                                               │
│                                                                 │
│  我嘗試了兩種方法都失敗了：                                     │
│  1. 直接載入模型 → 記憶體不足                                   │
│  2. 使用低精度模型 → 品質不佳                                   │
│                                                                 │
│  建議選項：                                                     │
│  A. 使用雲端 GPU（需要費用）                                    │
│  B. 降低輸出解析度（512→256）                                   │
│  C. 換用更小的模型                                              │
│                                                                 │
│  您希望怎麼做？                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 危險操作確認

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚠️ 確認操作                                                   │
│                                                                 │
│  即將執行：刪除 output/ 資料夾中的舊檔案                        │
│  影響範圍：約 50 個檔案                                         │
│                                                                 │
│  確定要繼續嗎？(Y/N)                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 3. 學習新技能時

```
┌─────────────────────────────────────────────────────────────────┐
│  📚 發現技能缺口                                               │
│                                                                 │
│  我需要學習：如何在 ComfyUI 中使用 ControlNet                   │
│                                                                 │
│  計劃：                                                         │
│  1. 搜尋 ControlNet 使用教學                                    │
│  2. 下載必要的模型                                              │
│  3. 建立測試工作流程                                            │
│                                                                 │
│  預計耗時：10-15 分鐘                                           │
│                                                                 │
│  是否繼續？(Y/N)                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 記憶系統使用

### 自動記錄的內容

| 類型 | 儲存位置 | 內容 |
|------|----------|------|
| 成功經驗 | Archival Memory | 驗證過的解決方案 |
| 失敗教訓 | Archival Memory | 錯誤原因 + 避免方法 |
| 當前進度 | Core Memory | 目標、策略、進度 |
| 學習要點 | Archival Memory | 新學到的技能 |

### 記憶格式範例

```markdown
## 學習記錄：ComfyUI LoRA 載入

**情境**：需要在 ComfyUI 中使用自訓練的 LoRA

**問題**：直接使用 Load LoRA 節點失敗

**解決方案**：
1. 確認 LoRA 檔案在 models/loras/ 目錄
2. 使用 LoraLoader 節點（不是 Load LoRA）
3. 設定 strength_model 和 strength_clip

**驗證**：成功載入並生成圖片

**標籤**：comfyui, lora, troubleshooting
```

---

## 停止與恢復

### 手動停止

```
輸入：停止 / stop / cancel
```

Agent 會：
1. 保存當前進度到 Memory
2. 輸出已完成的部分
3. 列出剩餘任務

### 恢復執行

```
/evolve 繼續之前的任務
```

Agent 會：
1. 從 Memory 讀取上次進度
2. 確認是否要繼續
3. 從中斷處繼續執行

---

## 最佳實踐

### 1. 目標描述要具體

```
❌ 差：/evolve 做一個好看的網站
✅ 好：/evolve 建立一個響應式登入頁面，要有：
       - 漸層背景
       - 表單驗證
       - 載入動畫
       - 錯誤提示
```

### 2. 設定驗收標準

```
/evolve 優化這段程式碼的效能
       驗收標準：執行時間降低 50%
       測試方式：console.time 計時
```

### 3. 提供約束條件

```
/evolve 重構 UserService
       約束：
       - 不改變 API 介面
       - 保持向後相容
       - 測試覆蓋率 > 80%
```

---

## 常見問題

### Q: Agent 卡在某個步驟怎麼辦？

輸入 `分析一下目前的情況` 或 `為什麼卡住了`，Agent 會：
1. 輸出當前狀態診斷
2. 列出嘗試過的方法
3. 提出替代方案

### Q: 如何讓 Agent 換個方向嘗試？

```
試試別的方法，不要用 [某方法]
```

### Q: 如何查看學習記錄？

```
顯示這次任務學到了什麼
```

### Q: 最大迭代次數可以改嗎？

目前預設 10 次。如需調整：
```
/evolve [目標] --max-iterations 20
```

---

## 與其他工具的整合

### 使用 PAL 深度思考

遇到複雜問題時，Agent 會自動呼叫：
```python
mcp__pal__thinkdeep({
    "step": "分析問題根因",
    "findings": "...",
    "hypothesis": "...",
    ...
})
```

### 使用 Memory 儲存

```python
# 儲存成功經驗
mcp__claude-dev-memory__memory_archive({
    "content": "學習記錄內容",
    "type": "learning",
    "tags": ["comfyui", "lora"]
})

# 查詢相關經驗
mcp__claude-dev-memory__memory_search({
    "query": "ComfyUI LoRA 問題",
    "filter": "learning"
})
```

---

## 範例場景

### 場景 1：建立 ComfyUI 工作流程

```
用戶：/evolve 建立一個能批量生成遊戲道具圖片的系統

Agent：
📋 目標分析完成

目標：建立批量遊戲道具圖片生成系統
驗收標準：
- 能一次生成 10+ 張道具圖片
- 風格一致（使用 LoRA）
- 背景透明（PNG）
- 解析度 512x512

子目標：
1. ⏳ 確認 ComfyUI 環境
2. ⏳ 建立基礎工作流程
3. ⏳ 加入 LoRA 風格控制
4. ⏳ 實作背景移除
5. ⏳ 實作批量生成
6. ⏳ 輸出格式處理

開始執行...
```

### 場景 2：效能優化

```
用戶：/evolve 優化 UserList component，目標是首次渲染 < 100ms

Agent：
📋 目標分析完成

目標：UserList 首次渲染 < 100ms
當前狀態：需要先測量現有效能

子目標：
1. ⏳ 測量當前效能基準
2. ⏳ 識別效能瓶頸
3. ⏳ 實作優化方案
4. ⏳ 驗證效能提升

開始執行...

---
🔄 執行子目標 1：測量效能基準

Plan：使用 React DevTools Profiler 測量
Do：[執行測量...]
Check：當前首次渲染 450ms
Act：記錄基準，進入下一步

---
🔄 執行子目標 2：識別瓶頸

發現問題：
1. 渲染 1000 個 UserCard，無虛擬化
2. 每個 UserCard 都重新計算 avatar URL
3. useEffect 觸發多次 re-render

優化方案：
1. 加入 react-window 虛擬化
2. useMemo 快取 avatar URL
3. 合併 useEffect dependencies

繼續執行...
```

---

*指南版本：1.0*
*建立日期：2025-12-31*
