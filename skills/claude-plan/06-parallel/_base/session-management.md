# å¤š Session é è¨­ä¸¦è¡Œ

## è¨­è¨ˆç†å¿µ

**ä¸¦è¡Œæ˜¯é è¨­ï¼Œè€Œéé¸é …** â€” æ–° Session è‡ªå‹•åŠ å…¥ä¸¦è¡ŒåŸ·è¡Œã€‚

## ä¸¦è¡Œæ¶æ§‹

```
                    Plan: é›»å•† MVP
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“               â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Task A  â”‚     â”‚ Task B  â”‚     â”‚ Task C  â”‚
    â”‚å¾Œç«¯ API â”‚     â”‚å‰ç«¯ UI  â”‚     â”‚è³‡æ–™åº«   â”‚
    â”‚[å¯ä¸¦è¡Œ] â”‚     â”‚[å¯ä¸¦è¡Œ] â”‚     â”‚[å¯ä¸¦è¡Œ] â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
    Session 1       Session 2       Session 3
    (è‡ªå‹•èªé ˜)      (è‡ªå‹•èªé ˜)      (è‡ªå‹•èªé ˜)
```

## Session ç”Ÿå‘½é€±æœŸ

### å‰µå»º

```bash
# ä»»ä½•çµ‚ç«¯åŸ·è¡Œ
/claude-plan

# ç³»çµ±è‡ªå‹•ï¼š
# 1. æª¢æŸ¥æ˜¯å¦æœ‰é€²è¡Œä¸­çš„è¨ˆç•«
# 2. å¦‚æœ‰ï¼Œæª¢æŸ¥å¯èªé ˜çš„ä»»å‹™
# 3. è‡ªå‹•èªé ˜ç¬¬ä¸€å€‹å¯ç”¨ä»»å‹™
# 4. é–‹å§‹åŸ·è¡Œ PDCA
```

### é‹è¡Œ

```yaml
session_loop:
  while task = claim_task():
    execute_pdca(task)
    on_complete:
      - release_lock(task)
      - update_status(task)
      - notify_downstream()
    on_failure:
      - handle_error()
      - possibly_release_lock()
```

### çµ‚æ­¢

```yaml
termination_conditions:
  - "æ‰€æœ‰ä»»å‹™å®Œæˆ"
  - "ç„¡å¯èªé ˜ä»»å‹™ä¸”ç„¡é˜»å¡ä»»å‹™"
  - "ç”¨æˆ¶ä¸»å‹•çµ‚æ­¢"
  - "é”åˆ°æœ€å¤§é–’ç½®æ™‚é–“"
```

## ä»»å‹™èªé ˜æ©Ÿåˆ¶

### èªé ˜é‚è¼¯

```python
def claim_task(session_id):
    # 1. ç²å–æ‰€æœ‰ä»»å‹™
    tasks = load_all_tasks()

    # 2. ç¯©é¸å¯èªé ˜ä»»å‹™
    claimable = [t for t in tasks if (
        t.status == "pending" and
        t.lock is None and
        all_dependencies_completed(t)
    )]

    if not claimable:
        return None

    # 3. é¸æ“‡æœ€å„ªå…ˆçš„ä»»å‹™
    task = select_highest_priority(claimable)

    # 4. ç²å–é–
    lock = acquire_lock(task.id, session_id)

    if lock:
        return task
    else:
        # è¢«å…¶ä»– Session æ¶å…ˆï¼Œé‡è©¦
        return claim_task(session_id)
```

### å„ªå…ˆç´šæ’åº

```yaml
priority_factors:
  # é«˜å„ªå…ˆç´š
  - "é˜»å¡å…¶ä»–ä»»å‹™çš„æ•¸é‡"
  - "ç”¨æˆ¶æŒ‡å®šçš„å„ªå…ˆç´š"

  # ä¸­ç­‰
  - "ä»»å‹™è¤‡é›œåº¦ï¼ˆç°¡å–®å„ªå…ˆï¼‰"
  - "å‰µå»ºæ™‚é–“ï¼ˆå…ˆé€²å…ˆå‡ºï¼‰"

  # ä½å„ªå…ˆç´š
  - "éš¨æ©Ÿå› å­ï¼ˆé¿å…é¤“æ­»ï¼‰"
```

## ä»»å‹™é–æ©Ÿåˆ¶

### é–çµæ§‹

```json
{
  "task_id": "backend-api",
  "lock": {
    "session_id": "session-001",
    "acquired_at": "2025-01-21T10:30:00Z",
    "expires_at": "2025-01-21T11:30:00Z",
    "heartbeat": "2025-01-21T10:45:00Z"
  }
}
```

### é–æ“ä½œ

```yaml
lock_operations:
  acquire:
    - æª¢æŸ¥ä»»å‹™æ˜¯å¦å·²é–å®š
    - åŸå­æ€§è¨­ç½®é–
    - è¿”å›æˆåŠŸ/å¤±æ•—

  release:
    - é©—è­‰æ˜¯ç•¶å‰ Session çš„é–
    - æ¸…é™¤é–
    - æ›´æ–°ä»»å‹™ç‹€æ…‹

  renew:
    - å®šæœŸæ›´æ–° heartbeat
    - å»¶é•· expires_at

  force_release:
    - ç”¨æ–¼éæœŸé–æ¸…ç†
    - ç”¨æ–¼ Session æ„å¤–çµ‚æ­¢å¾Œ
```

### é–è¶…æ™‚è™•ç†

```python
def cleanup_expired_locks():
    """å®šæœŸåŸ·è¡Œï¼ˆå»ºè­°æ¯ 5 åˆ†é˜ï¼‰"""
    now = datetime.now()

    for task in all_tasks():
        if task.lock and task.lock.expires_at < now:
            # é–å·²éæœŸ
            if task.lock.session_still_active():
                # Session é‚„åœ¨ï¼Œåªæ˜¯å¿˜äº†æ›´æ–°
                task.lock.renew()
            else:
                # Session å·²æ­»ï¼Œé‡‹æ”¾é–
                task.lock.force_release()
                task.status = "pending"  # é‡æ–°å¯èªé ˜
```

## è¡çªè™•ç†

### æª”æ¡ˆè¡çª

```
Session 1 ä¿®æ”¹ src/api/user.ts
Session 2 ä¹Ÿä¿®æ”¹ src/api/user.ts
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡çªåµæ¸¬æ™‚æ©Ÿ                                            â”‚
â”‚  1. commit å‰æª¢æŸ¥                                        â”‚
â”‚  2. push å‰æª¢æŸ¥                                          â”‚
â”‚  3. ä»»å‹™å®Œæˆæ™‚æª¢æŸ¥                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è™•ç†ç­–ç•¥                                                â”‚
â”‚  1. è‡ªå‹•åˆä½µï¼ˆä¸åŒå€å¡Šï¼‰                                 â”‚
â”‚  2. æ™ºèƒ½åˆä½µï¼ˆAI åˆ†æï¼‰                                  â”‚
â”‚  3. äººå·¥ä»‹å…¥ï¼ˆç„¡æ³•è‡ªå‹•è§£æ±ºï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾è³´è¡çª

```
Task A ä¾è³´ Task B
Session 1 å®Œæˆ Task Aï¼ˆé æœŸ Task B çš„æŸå€‹ä»‹é¢ï¼‰
Session 2 ä¿®æ”¹ Task Bï¼ˆæ”¹è®Šäº†ä»‹é¢ï¼‰
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è™•ç†ç­–ç•¥                                                â”‚
â”‚  1. é‡è·‘ Task A çš„æ¸¬è©¦                                   â”‚
â”‚  2. å¦‚æœå¤±æ•—ï¼Œé€šçŸ¥ Session 1                             â”‚
â”‚  3. Session 1 éœ€è¦é©é…æ–°ä»‹é¢                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è² è¼‰å‡è¡¡

### ä»»å‹™åˆ†é…ç­–ç•¥

```yaml
distribution_strategies:
  # é è¨­ï¼šèƒ½åŠ›åŒ¹é…
  capability_match:
    - æ ¹æ“š Session æ­·å²è¡¨ç¾
    - è¤‡é›œä»»å‹™åˆ†é…çµ¦ã€ŒæˆåŠŸç‡é«˜ã€çš„ Session
    - ç°¡å–®ä»»å‹™åˆ†é…çµ¦ã€Œæ–°ã€Session

  # å¯é¸ï¼šè¼ªè©¢
  round_robin:
    - ä»»å‹™å‡å‹»åˆ†é…
    - é©åˆåŒè³ªåŒ–ä»»å‹™

  # å¯é¸ï¼šæœ€å°‘ç­‰å¾…
  least_wait:
    - åˆ†é…çµ¦æœ€æ—©é–’ç½®çš„ Session
    - æœ€å¤§åŒ–ä¸¦è¡Œåº¦
```

### å‹•æ…‹èª¿æ•´

```python
def adjust_distribution():
    """æ ¹æ“šåŸ·è¡Œæƒ…æ³å‹•æ…‹èª¿æ•´"""

    # æ”¶é›†æŒ‡æ¨™
    metrics = collect_session_metrics()

    for session in active_sessions:
        if session.error_rate > 0.3:
            # éŒ¯èª¤ç‡é«˜ï¼Œæ¸›å°‘åˆ†é…
            session.priority_factor *= 0.5

        if session.avg_completion_time < average:
            # å®Œæˆé€Ÿåº¦å¿«ï¼Œå¢åŠ åˆ†é…
            session.priority_factor *= 1.2
```

## ç›£æ§èˆ‡å¯è¦–åŒ–

### Session ç‹€æ…‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Active Sessions                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Session 1  â”‚ ğŸŸ¢ Working â”‚ Task: backend-api â”‚ 60%     â”‚
â”‚  Session 2  â”‚ ğŸŸ¢ Working â”‚ Task: frontend-ui â”‚ 45%     â”‚
â”‚  Session 3  â”‚ ğŸŸ¡ Idle    â”‚ Waiting for task  â”‚ -       â”‚
â”‚  Session 4  â”‚ ğŸ”´ Error   â”‚ Task: checkout    â”‚ Failed  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸¦è¡Œæ•ˆç‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Parallelism Metrics                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸¦è¡Œåº¦: 3/4 (75%)                                      â”‚
â”‚  å¹³å‡ä»»å‹™æ™‚é–“: 25 min                                    â”‚
â”‚  ç¸½ååé‡: 8 tasks/hr                                   â”‚
â”‚  é–ç«¶çˆ­ç‡: 5%                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
