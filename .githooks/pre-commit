#!/bin/bash
# Pre-commit hook for self-evolving-agent
# Âº∑Âà∂Ê™¢Êü•ÈªûÔºöcommit ÂâçÂøÖÈ†àÈÄöÈÅé

set -e

echo "üîç Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# ============================================
# Check 1: SKILL.md ÂøÖÈ†àÂ≠òÂú®‰∏îÊúâÂÖßÂÆπ
# ============================================
echo -n "  ‚úì Checking SKILL.md exists... "
if [ ! -f "SKILL.md" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "    ERROR: SKILL.md not found!"
    ERRORS=$((ERRORS + 1))
elif [ ! -s "SKILL.md" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "    ERROR: SKILL.md is empty!"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Check 2: SKILL.md ÂøÖÈ†àÊúâ frontmatter
# ============================================
echo -n "  ‚úì Checking SKILL.md frontmatter... "
if ! head -1 SKILL.md | grep -q "^---$"; then
    echo -e "${RED}FAILED${NC}"
    echo "    ERROR: SKILL.md missing frontmatter (should start with ---)"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Check 3: SKILL.md ÂøÖÈ†àÊúâÁâàÊú¨Ëôü
# ============================================
echo -n "  ‚úì Checking SKILL.md version... "
if ! grep -q "^version:" SKILL.md; then
    echo -e "${RED}FAILED${NC}"
    echo "    ERROR: SKILL.md missing version field"
    ERRORS=$((ERRORS + 1))
else
    VERSION=$(grep "^version:" SKILL.md | head -1 | cut -d: -f2 | tr -d ' ')
    echo -e "${GREEN}OK${NC} (v${VERSION})"
fi

# ============================================
# Check 4: Ê™¢Êü•Â§ßÊ™îÊ°à (> 1MB)
# ============================================
echo -n "  ‚úì Checking for large files... "
LARGE_FILES=$(find . -type f -size +1M -not -path "./.git/*" 2>/dev/null || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo "    Large files detected (>1MB):"
    echo "$LARGE_FILES" | while read f; do echo "      - $f"; done
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Check 5: Ê™¢Êü• trailing whitespace (staged files only)
# ============================================
echo -n "  ‚úì Checking trailing whitespace... "
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|txt|yml|yaml|json)$' || true)
WHITESPACE_ERRORS=0
if [ -n "$STAGED_FILES" ]; then
    for file in $STAGED_FILES; do
        if [ -f "$file" ] && grep -q '[[:space:]]$' "$file" 2>/dev/null; then
            if [ $WHITESPACE_ERRORS -eq 0 ]; then
                echo -e "${YELLOW}WARNING${NC}"
            fi
            echo "    Trailing whitespace in: $file"
            WHITESPACE_ERRORS=$((WHITESPACE_ERRORS + 1))
        fi
    done
fi
if [ $WHITESPACE_ERRORS -eq 0 ]; then
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Check 6: README.md ÂøÖÈ†àÂ≠òÂú®
# ============================================
echo -n "  ‚úì Checking README.md exists... "
if [ ! -f "README.md" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "    ERROR: README.md not found!"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Summary
# ============================================
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Pre-commit checks failed with $ERRORS error(s)${NC}"
    echo "   Fix the errors above and try again."
    echo "   To skip this check (not recommended): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-commit checks passed${NC}"
    exit 0
fi
